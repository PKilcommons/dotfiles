#!/bin/bash
# Show the number of Github Action minutes used in billing period based on the
# PAT provided in the `$ORG_GH_PAT` environmental variable.

set -e

resp=$(
    curl -L \
      -s \
      -w "%{http_code}" \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer ${ORG_GH_PAT}"\
      -H "X-GitHub-Api-Version: 2022-11-28" \
      https://api.github.com/orgs/transigma/settings/billing/actions
)

status_code=$(tail -n 1 <<< $resp)
resp=$(head -n -1 <<< $resp)

if [ $status_code == "200" ];
    then jq .total_minutes_used <<< $resp | xargs printf "%s minutes\n"
else
    jq .message <<< $resp | xargs printf "Error (%s): %s\n" $status_code
fi
